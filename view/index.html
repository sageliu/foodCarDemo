<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <script src="../dist/js/flexible.js"></script>
    <title>交易</title>
    <link rel="stylesheet" href="../dist/css/lanzuan_mobile.css"/>
    <script src="../dist/js/makegrid.js"></script>
    <script>lib.flexible.makeGridMode("750-12");</script>
    <script src="../dist/js/scrollfix.js"></script>
    <script src="../dist/js/lanzuan_mobile.js"></script>
    <script src="../dist/js/jquery.fly.min.js"></script>
</head>
<body>
<header id="top">
    <a href="#" class="link"><img src="../assest/images/head-row.png">&nbsp;返回首页</a>

    <div class="head-rt">
        <img src="../assest/images/zuanshi.png" alt="" class="dfi-img"/>
        <b>10000</b>
        <a href="">提现</a>
    </div>
</header>
<div class="panel hasHead hasFoot deal-wrap">
    <!-- 以下是导航栏的标签-->
    <div class="deal-title">
            <div class='ub'>
                <div class='ub-f1 active'>
                    <a href="#">
                        <i></i>
                        <span>蓝钻交易</span>
                    </a>
                </div>
                <div class='ub-f1'>
                    <a href="#">
                        <i class="qiugou"></i>
                        <span>蓝钻求购</span>
                    </a>
                </div>
                <div class='ub-f1'>
                    <a href="#">
                        <i class="duihuan"></i>
                        <span>蓝钻商城</span>
                    </a>
                </div>
            </div>
        </div>
    <div class="deal-title2">
            <ul class="deal-tab">
                <li class="current">全部</li>
                <li>
                    <span>价格</span>

                    <div class="sort "></div>
                </li>
                <li>
                    <span>出售数量</span>

                    <div class="sort "></div>
                </li>
            </ul>
        </div>
    <!-- 以下是商品列表的标签-->
    <div class="deal-con bdn-lpy">
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">哇哇卡卡</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1000000.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>

                <a href="#" ></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1000000.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1000000.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#" ></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#" ></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">用户名最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
        <div class='ub'>
            <div class='ub-f1 deal-con-l'>
                <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>

                <p class="con">最长七字</p>
            </div>
            <div class='ub-f1 deal-con-m'>
                <p><span>1.00</span> 元</p>

                <p class="price">
                    <b>1元=1000钻</b>
                </p>

                <p class="time">< 23小时</p>
            </div>
            <div class='ub-f1 add add1'>
                <a href="#"></a>
            </div>
        </div>
    </div>
    <!-- 以下是购物车中的内容-->
    <div class="deal-car-con">
        <div class="bg">这个是透明色</div>
        <div class="car-clear">
            <h2>购物车</h2>
            <span class="remove"><img src="../assest/images/clear.png" alt=""/>清空</span>
        </div>
        <div class="car-con">
            <!--            <div class="deal-jiaoyi deal-con deal-wupin">
                            <div class='ub'>
                                <div class='ub-f1 deal-con-l'>
                                    <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>
                                    <p class="con">购物车里内容</p>
                                </div>
                                <div class='ub-f1 deal-con-m'>
                                    <p class="deal-con-m-price"><em>1.00</em> 元</p>
                                </div>
                                <div class='add ub-f1'>
                                    <a href="#" class="wupin"></a>
                                </div>
                            </div>

                        </div>
                        <div class="deal-jiaoyi deal-con deal-wupin deal-gray">
                            <div class='ub'>
                                <div class='ub-f1 deal-con-l'>
                                    <p><img src="../assest/images/zuanshi.png" alt=""/>10000</p>
                                    <p class="con">购物车里的东西</p>
                                </div>
                                <div class='ub-f1 deal-con-m'>
                                    <p class="deal-con-m-price"><em class="red">1.00</em> 元</p>
                                    <p class="guoqi">已过期</p>
                                </div>
                                <div class='ub-f1 add'>
                                    <a href="#" class="gray"></a>
                                </div>
                            </div>
                        </div>-->
        </div>
    </div>
    <!--<div class="shade"></div>-->
    <!-- 以下是购物车的标签-->
    <div class="deal-car">
        <div class='ub'>
            <div class='car ub-f1'>
                <a href="#">
                    <span class="xzlCar"></span>
                    <i>0</i>
                </a>
            </div>
            <div class='ub-f1 total'>
                <p>总计</p>

                <div class="total-con">
                    <div><img src="../assest/images/zuanshi.png" alt="" class="zs"/>200000</div>
                    <em>2.0元</em>
                </div>
            </div>
            <div class='ub-f1 close'>
                <a href="#">
                    结算
                </a>
            </div>
        </div>
    </div>


</div>
<!--以下是底部的按钮-->
<div class="end ub-ac ub-pc">
    <a href="##">确认售出</a>
    <!--<a href="##">出售蓝钻</a>-->
</div>
</body>
</html>

<script>
    //这是导航栏切换的效果
    $('.deal-title .ub div').live('tap', function () {
        $(this).addClass('active').siblings().removeClass('active');
    });

    //计数器，初始为0
    var flag = 0;
    var obj = {};
    //这是点击加号的效果
    obj[0] = 0;
    //以下是点击添加到购物车add，清空购物车remove，删除购物车中的单条商品del的效果
    $('.deal-con .add').live('click', function (e) {
//        console.log(e.target.classList);
        //购物车出现
        $('.deal-car').show();
        //如果点击的是删除本条商品的按钮
        if ($(e.target).hasClass('del')) {
            //删除购物车中的这条商品
            var goods = $(this).parent().parent()[0].className.match(/(goods\d+)/)[1];
            $("." + goods).removeClass("active " + goods);
            $(this).parent().parent().remove();
            var gFlag = goods.match(/goods(\d+)/)[1];
//            console.log(gFlag);
            //删除一个商品的时候，这个商品的
            obj[gFlag] = null;
            //购物车中的商品减少1
            flag--;
            //购物车显示的数字和flag一致
            $(".car.ub-f1").children().children().last().text(flag);
            //这个时候需要检测flag的数量，来处理购物车的高度
            //还要多我删除的这个商品，改变上架位置的商品的样式为可以添加的样式
            //处理的方式就是我添加进购物车的时候，我会给我这个商品一个样式+flag后缀，这样在删除的时候，我把对应的那个商品的
            //购物车中没有商品的时候，关闭购物车相关内容
//            console.log(flag);
            clearCar(flag);
            //实时变更购物车内容的高度为购物车中商品的个数的高度
            hei(flag);
            flyGoods(true);
            return
        } else if ($(e.target).hasClass('active')||$(e.target).hasClass('add')) {
            //已添加进购物车的商品，是不能再次添加的
            console.log(1);
            flyGoods(true);
            return
        }
        //购物车里面添加新点击的这个商品
        if (flag < 100) {
            for (var i = 0; i < 100; i++) {
                objFlag = obj[i];
                //利用对象的key不能重复的原理，去重，
                if (objFlag === null) {
                    //如果删除过购物车中的商品，那么对应的obj的key的位置是null
                    //那么对这个obj对象进行循环，找到被删除的位置null的key
                    //购物车的商品和原始的商品的标记都变成这个key的值
                    //同时obj这个key的位置就存入这个key的值
                    //如果没有找到，就向下一直查找
                    //找到之后，就退出查找。
                    objFlag = obj[i + 1];
                    _flag = i;
                    obj[i] = i;
                    break;
                } else {
                    //如果一次都没有删除，新添加的商品的序号标记就是这个点击的次数
                    _flag = flag;
                }
            }

            //购物车新加的东西，需要取到我点击的那个商品的信息，这个后台进行填写
            //给这件购物车的东西一个标识goods+_flag，用于删除这件商品，并还原上架商品的可添加进购物车的状态（由灰色变成蓝色的加号）时候使用

            //存储添加商品到购物车时的商品的具体信息到ary2
            var $tarStrObj = $(this).siblings().children();
            var ary2 = [];
            for (var t = 0; t < $tarStrObj.length; t++) {
                ary2[t] = $tarStrObj[t].innerText;
            }
//          console.log(ary2)
            //将这个商品的信息动态添加到购物车中的商品的信息的相应的位置
            var str = " <div class='deal-jiaoyi deal-con deal-wupin goods" + _flag + "'>" +
                    "<div class='ub'>" +
                    "<div class='ub-f1 deal-con-l'>" +
                    "<p><img src='../assest/images/zuanshi.png' alt=''/>" + ary2[0] + "</p>" +
                    "<p class='con'>" + ary2[1] + "</p>" +
                    "</div>" +
                    "<div class='ub-f1 deal-con-m'>" +
                    "<p class='deal-con-m-price'><em>" + ary2[2] + "</em></p>" +
                    "</div>" +
                    "<div class='add ub-f1'>" +
                    "<a href='#' class='wupin  del'></a>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            //添加商品到购物车的位置，如果购物车空，添加到末尾，如果不为空，添加到最上面
            if (flag == 0) {
                $(".car-con").append(str);
            } else {
                $(".car-con").children().first().before(str);
            }

            //加号的效果变成灰色的,给这件商品一个标识goods+_flag，用时删除的时候使用
            $(this).children().addClass('active goods' + _flag);
//            计数器，每次添加进购物车一件商品的时候，加1

            flag++;
            //购物车显示的数字和flag一致
            $(".car.ub-f1").children().children().last().text(flag);

        } else {

            //购物车中的商品，超出100件的提醒
            alert("尊敬的用户，很抱歉的提醒您，您的购物车最多可以添加100件商品");
            return
        }
        //最后一个商品的位置在购物车的上方
        $(".deal-con.bdn-lpy").css("margin-bottom", $('.deal-car').offset().height);
//        .px2rem(margin-bottom, 110rem);

        flyGoods(false);

    });

    $('.car.ub-f1').live('tap', function () {
        //点击购物车的时候，控制显示隐藏购物车中的内容
        $('.deal-car-con').toggle();
        $('.shade').toggle();
        hei(flag);
    });

    $('.deal-car-con .bg').live('tap', function () {
        //点击购物车里的遮罩层的时候，控制隐藏购物车中的内容
        $('.deal-car-con').toggle();
        hei(flag);
    });
    //添加购物车的remove按钮，点击之后，清空购物车中的内容
    //$(".car.ub-f1")这个需要更换成remove按钮的jq对象
    $(".remove").live('tap', function (e) {
        //购物车清空之后，购物车隐藏，
        //console.log(e.target);
        //需要处理点击穿透，改为click事件-.-
        setTimeout(function(){
//            $('.shade').hide();
            flag = 0;
            clearCar(flag);
        },350);
//        flag = 0;
//        clearCar(flag);
    });


    //-----------以下是fly动画-----------
    function flyGoods(bool){
        if(bool==true){
            return
        }
        //是$(".addcar")这个元素点击促发的 开始动画的位置就是这个元素的位置为起点
        var addcar = $(this);
//            alert(addcar);
        //ar img = addcar.parent().find('img').attr('src');
        //ar flyer = $('<img class="u-flyer" src="'+img+'">');
        var flyer = $('<div id="add"></div>');
//            alert(1)

        flyer.fly({
            start: {
                left: event.clientX,
                top: event.clientY
            },
            end: {
                    left: $(".xzlCar").offset().left+50,
                    top: $(".xzlCar").offset().top,
//                left: 40,
//                top: 1100,
                width: 0,
                height: 0
            },
            onEnd: function () {
                $("#msg").show().animate({width: '250px'}, 200).fadeOut(1000);
                addcar.css("cursor", "default").removeClass('orange').unbind('click');
                this.destory();
            }
        });
    }
    //计算购物车中内容高度的函数
    //新引入的jq把我原来的数据给影响了，获取不到offset()的数据。。。。。。。。。
    function hei(flag){
        if(flag===0){
            return
        }
        var zhezhaoMin = $(".deal-title2").offset();
        //购物车中的内容的高度
        var a =flag * $(".deal-jiaoyi").children().offset().height;
        //var a=$(".car-con").offset().height;
        //购物车的top位置
        var b = $(".deal-car").offset().top;
        //遮罩的top位置
        var c = zhezhaoMin.top;
        //遮罩的最小高度
        var d = zhezhaoMin.height;
        //购物车的标题栏的高度
        var e = $(".car-clear").offset().height;

        var f = b - c - d - e;
        //这个是购物车中的商品的最大高度
//        a = (a > f) ? f : a;

        var g=$(".car-con");
        if (a > f) {
            a = f;
            //高度太高的时候，就增加滚动条了
            g.css("overflow", "auto");
        } else {
            a = flag * $(".deal-jiaoyi").children().offset().height;
        }
        g.css("height", a + "px");
    }


    //清空购物车中的内容的函数
    function clearCar(flag) {
        if (flag === 0) {
            //所有内容都还原成初始的值
            _flag = 0;
            obj = {};
            ary2 = [];
            //购物车中的数据变成0
            $(".car.ub-f1").children().children().last().text(flag);
            //购物车隐藏
            $('.deal-car').hide();
            //遮罩层隐藏            //清空购物车
            $('.deal-car-con').hide().children().last().children().remove();

            //清空所有购物车中的内容
            //还原所有商品的样式为可添加时候的样式
            $(".ub-f1.add>a").removeClass();
            //最后一个商品的位置向下到底
            $(".deal-con.bdn-lpy").css("margin-bottom", 0);


        } else {
            return
        }
    }
</script>
